<!doctype html>
<html lang="en" dir="ltr" data-theme="dark">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1, minimum-scale=1, maximum-scale=5, viewport-fit=cover"/>
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate, max-age=0"/>
  <meta http-equiv="Pragma" content="no-cache"/>
  <meta http-equiv="Expires" content="0"/>
  <title>My Library ‚Äî Signal Pilot Education</title>
  <meta name="description" content="Your personal learning library: downloaded resources, bookmarked lessons, notes, and achievements.">
  <link rel="canonical" href="https://education.signalpilot.io/my-library.html">
  <meta name="theme-color" content="#05070d">
  <link rel="manifest" href="/manifest.json">
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/icons/icon-180x180.png">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;700&family=Gugi&family=Space+Grotesk:wght@500;700&display=swap" rel="stylesheet">

  <link rel="stylesheet" href="/assets/signalpilot-theme.css">
  <link rel="stylesheet" href="/assets/edu.css">
  <link rel="stylesheet" href="/assets/chatbot.css">
  <link rel="stylesheet" href="/assets/auth-ui.css">

  <!-- Logger must load first -->
  <script src="/assets/logger.js"></script>
  <script src="/assets/dev-utils.js" defer></script>
  <script src="/assets/structured-data.js" defer></script>
  <script src="/assets/lazy-load.js" defer></script>

  <style>
    .library-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
      gap: 1.5rem;
      margin: 2rem 0;
    }

    .library-section {
      background: var(--bg-2);
      border: 1px solid rgba(255, 255, 255, 0.08);
      border-radius: 12px;
      padding: 1.5rem;
    }

    .library-section h3 {
      margin: 0 0 1rem 0;
      color: var(--accent);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .library-item {
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.05);
      border-radius: 8px;
      padding: 1rem;
      margin-bottom: 0.75rem;
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 1rem;
      transition: all 0.2s ease;
    }

    .library-item:hover {
      background: rgba(255, 255, 255, 0.05);
      border-color: rgba(91, 138, 255, 0.3);
      transform: translateX(4px);
    }

    .library-item-info {
      flex: 1;
    }

    .library-item-title {
      font-weight: 600;
      color: var(--text);
      margin-bottom: 0.25rem;
    }

    .library-item-meta {
      font-size: 0.85rem;
      color: var(--muted);
    }

    .library-item-actions {
      display: flex;
      gap: 0.5rem;
    }

    .stat-card {
      text-align: center;
      padding: 1.5rem;
      background: linear-gradient(135deg, rgba(91, 138, 255, 0.1), rgba(118, 221, 255, 0.1));
      border: 1px solid rgba(91, 138, 255, 0.2);
      border-radius: 12px;
    }

    .stat-number {
      font-size: 2.5rem;
      font-weight: 700;
      background: linear-gradient(135deg, #5b8aff, #76ddff);
      -webkit-background-clip: text;
      background-clip: text;
      -webkit-text-fill-color: transparent;
      margin-bottom: 0.5rem;
    }

    .stat-label {
      color: var(--muted);
      font-size: 0.9rem;
    }

    .empty-state {
      text-align: center;
      padding: 3rem 2rem;
      color: var(--muted);
    }

    .empty-state-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }

    .achievement-badge {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      padding: 0.75rem 1rem;
      background: rgba(255, 215, 0, 0.1);
      border: 1px solid rgba(255, 215, 0, 0.2);
      border-radius: 8px;
      margin: 0.5rem 0.5rem 0.5rem 0;
    }

    .achievement-badge.locked {
      opacity: 0.4;
      background: rgba(255, 255, 255, 0.02);
      border-color: rgba(255, 255, 255, 0.1);
    }

    /* Study Calendar */
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(13, 1fr);
      gap: 4px;
      margin: 1rem 0;
    }

    .calendar-day {
      width: 100%;
      aspect-ratio: 1;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 3px;
      position: relative;
      transition: all 0.2s ease;
    }

    .calendar-day.active-1 { background: rgba(91, 138, 255, 0.3); }
    .calendar-day.active-2 { background: rgba(91, 138, 255, 0.5); }
    .calendar-day.active-3 { background: rgba(91, 138, 255, 0.7); }
    .calendar-day.active-4 { background: rgba(91, 138, 255, 0.9); }
    .calendar-day.active-5 { background: rgba(91, 138, 255, 1); }

    .calendar-day:hover {
      transform: scale(1.2);
      z-index: 10;
    }

    .calendar-day:hover::after {
      content: attr(data-tooltip);
      position: absolute;
      bottom: 100%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0, 0, 0, 0.9);
      color: white;
      padding: 0.5rem;
      border-radius: 4px;
      font-size: 0.75rem;
      white-space: nowrap;
      margin-bottom: 0.5rem;
      z-index: 100;
    }

    /* Streak Calendar */
    .streak-day {
      width: 40px;
      height: 40px;
      border-radius: 8px;
      background: rgba(255, 255, 255, 0.05);
      border: 2px solid rgba(255, 255, 255, 0.1);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.2rem;
      transition: all 0.2s ease;
    }

    .streak-day.completed {
      background: linear-gradient(135deg, #ff6b35, #f7931e);
      border-color: #ff6b35;
      transform: scale(1.1);
    }

    .streak-day.today {
      border-color: #5b8aff;
      border-width: 3px;
      box-shadow: 0 0 12px rgba(91, 138, 255, 0.5);
    }

    /* Progress Chart */
    .progress-bar-container {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      margin: 1rem 0;
    }

    .progress-bar-item {
      display: flex;
      align-items: center;
      gap: 1rem;
    }

    .progress-bar-label {
      min-width: 80px;
      font-size: 0.85rem;
      color: var(--muted);
    }

    .progress-bar-track {
      flex: 1;
      height: 30px;
      background: rgba(255, 255, 255, 0.05);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }

    .progress-bar-fill {
      height: 100%;
      background: linear-gradient(135deg, #5b8aff, #76ddff);
      border-radius: 6px;
      transition: width 0.5s ease;
      display: flex;
      align-items: center;
      justify-content: flex-end;
      padding-right: 0.5rem;
      color: white;
      font-size: 0.75rem;
      font-weight: 600;
    }

    /* Certificate Cards */
    .certificate-card {
      text-align: center;
      padding: 1.5rem;
      background: rgba(255, 255, 255, 0.02);
      border: 1px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .certificate-card.unlocked {
      background: linear-gradient(135deg, rgba(91, 138, 255, 0.1), rgba(118, 221, 255, 0.1));
      border-color: rgba(91, 138, 255, 0.3);
    }

    .certificate-card.unlocked:hover {
      transform: translateY(-4px);
      box-shadow: 0 8px 16px rgba(91, 138, 255, 0.2);
    }

    .certificate-icon {
      font-size: 3rem;
      margin-bottom: 0.5rem;
    }

    .certificate-title {
      font-weight: 600;
      font-size: 1.1rem;
      color: var(--text);
      margin-bottom: 0.5rem;
    }

    .certificate-progress {
      font-size: 0.85rem;
      color: var(--muted);
      margin-bottom: 1rem;
    }

    .certificate-card .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
  </style>
</head>
<body>
  <div class="bg-stars" aria-hidden="true"></div>
  <canvas id="constellations" class="sp-constellations" aria-hidden="true"></canvas>
  <div class="bg-aurora" aria-hidden="true"></div>

<header class="sp-header">
  <div class="wrap">
    <a href="https://signalpilot.io" class="brand">
      <span>Signal Pilot</span>
    </a>
    <nav id="mainnav" aria-label="Main">
      <ul>
        <li><a href="/">Education</a></li>
        <li><a aria-current="page" href="/my-library.html">My Library</a></li>
        <li><a href="/search.html">üîç Search</a></li>
      </ul>
    </nav>
    <div class="header-ctls">
      <button id="themeToggle" class="btn btn-ghost btn-sm" type="button" aria-label="Toggle theme">
        <span id="theme-icon">üåô</span>
      </button>
      <button id="menuToggle" class="menu-toggle" aria-expanded="false">Menu ‚ò∞</button>
    </div>
  </div>
</header>

<main>
  <!-- Hero Section -->
  <section class="hero" style="padding: 2rem 0 1rem;">
    <div class="wrap" style="text-align: center;">
      <h1 class="headline xl">üìö My Library</h1>
      <p class="lead">Your personal learning hub - all your progress in one place</p>
      <button id="refresh-library" class="btn btn-ghost btn-sm" style="margin-top: 1rem;" onclick="location.reload()">
        üîÑ Refresh Data
      </button>
    </div>
  </section>

  <!-- Stats Overview -->
  <section class="wrap" style="margin: 2rem auto;">
    <div class="library-grid">
      <div class="stat-card">
        <div class="stat-number" id="stat-completed">0</div>
        <div class="stat-label">Lessons Completed</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-downloads">0</div>
        <div class="stat-label">Resources Downloaded</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-bookmarks">0</div>
        <div class="stat-label">Bookmarked Lessons</div>
      </div>
      <div class="stat-card">
        <div class="stat-number" id="stat-streak">0</div>
        <div class="stat-label">Day Streak üî•</div>
      </div>
    </div>
  </section>

  <!-- Study Calendar -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üìÖ Study Calendar</h3>
      <p style="font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem;">Your activity over the last 90 days</p>
      <div id="study-calendar"></div>
    </div>
  </section>

  <!-- Streak Tracker -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üî• Streak Tracker - Don't Break the Chain!</h3>
      <div id="streak-tracker">
        <div style="text-align: center; margin: 2rem 0;">
          <div style="font-size: 3rem; font-weight: 700; background: linear-gradient(135deg, #ff6b35, #f7931e); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent;">
            <span id="streak-days">0</span> Days
          </div>
          <p style="color: var(--muted); margin-top: 0.5rem;">Keep learning every day to maintain your streak!</p>
        </div>
        <div id="streak-calendar" style="display: flex; gap: 0.5rem; flex-wrap: wrap; justify-content: center;"></div>
      </div>
    </div>
  </section>

  <!-- Progress Chart -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üìà Progress Over Time</h3>
      <p style="font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem;">Lessons completed each week</p>
      <div id="progress-chart"></div>
    </div>
  </section>

  <!-- Downloaded Resources -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üì• Downloaded Resources</h3>
      <div id="downloads-list">
        <div class="empty-state">
          <div class="empty-state-icon">üì•</div>
          <p>No resources downloaded yet.</p>
          <p style="font-size: 0.9rem;">Download checklists from lessons to see them here!</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Bookmarked Lessons -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üîñ Bookmarked Lessons</h3>
      <div id="bookmarks-list">
        <div class="empty-state">
          <div class="empty-state-icon">üîñ</div>
          <p>No bookmarked lessons yet.</p>
          <p style="font-size: 0.9rem;">Bookmark lessons to save them for later!</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Starred Favorites -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>‚≠ê Starred Favorites</h3>
      <p style="font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem;">Your absolute best lessons - quick access to the gems</p>
      <div id="favorites-list">
        <div class="empty-state">
          <div class="empty-state-icon">‚≠ê</div>
          <p>No favorites yet.</p>
          <p style="font-size: 0.9rem;">Star your best lessons for quick access!</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Your Notes -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üìù Your Notes</h3>
      <div id="notes-list">
        <div class="empty-state">
          <div class="empty-state-icon">üìù</div>
          <p>No notes yet.</p>
          <p style="font-size: 0.9rem;">Take notes while studying to see them here!</p>
        </div>
      </div>
    </div>
  </section>

  <!-- Certificates -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üéì Certificates</h3>
      <p style="font-size: 0.9rem; color: var(--muted); margin-bottom: 1rem;">Download completion certificates to showcase your achievements</p>
      <div id="certificates-list">
        <div class="library-grid" style="grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));">
          <div class="certificate-card" data-tier="beginner">
            <div class="certificate-icon">üü¢</div>
            <div class="certificate-title">Beginner Tier</div>
            <div class="certificate-progress" id="cert-beginner-progress">0/12 lessons</div>
            <button class="btn btn-primary btn-sm" id="cert-beginner-btn" disabled>Download Certificate</button>
          </div>
          <div class="certificate-card" data-tier="intermediate">
            <div class="certificate-icon">üü°</div>
            <div class="certificate-title">Intermediate Tier</div>
            <div class="certificate-progress" id="cert-intermediate-progress">0/15 lessons</div>
            <button class="btn btn-primary btn-sm" id="cert-intermediate-btn" disabled>Download Certificate</button>
          </div>
          <div class="certificate-card" data-tier="advanced">
            <div class="certificate-icon">üî¥</div>
            <div class="certificate-title">Advanced Tier</div>
            <div class="certificate-progress" id="cert-advanced-progress">0/15 lessons</div>
            <button class="btn btn-primary btn-sm" id="cert-advanced-btn" disabled>Download Certificate</button>
          </div>
          <div class="certificate-card" data-tier="master">
            <div class="certificate-icon">üèÜ</div>
            <div class="certificate-title">Master Trader</div>
            <div class="certificate-progress" id="cert-master-progress">0/42 lessons</div>
            <button class="btn btn-primary btn-sm" id="cert-master-btn" disabled>Download Certificate</button>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Achievements -->
  <section class="wrap" style="margin: 3rem auto;">
    <div class="library-section">
      <h3>üèÜ Achievements</h3>
      <div id="achievements-list">
        <div class="empty-state">
          <div class="empty-state-icon">üèÜ</div>
          <p>No achievements unlocked yet.</p>
          <p style="font-size: 0.9rem;">Complete lessons to earn achievements!</p>
        </div>
      </div>
    </div>
  </section>
</main>

<footer class="sp-footer">
  <div class="wrap">
    <div>¬© <span id="year"></span> Signal Pilot Labs, Inc.</div>
    <div class="links">
      <a href="https://signalpilot.io/privacy.html">Privacy</a>
      <a href="https://signalpilot.io/terms.html">Terms</a>
    </div>
  </div>
</footer>

<script src="/assets/signalpilot-theme.js"></script>
<script src="/assets/sp-bg.js"></script>
<script src="/assets/analytics.js"></script>
<script src="/assets/pwa-init.js"></script>
<script src="/assets/config.js"></script>
<script src="/assets/supabase-client.js"></script>
<script src="/assets/auth-ui.js"></script>

<script>
// My Library functionality
(function() {
  'use strict';

  document.getElementById('year').textContent = new Date().getFullYear();

  // Load library data
  function loadLibraryData() {
    // Track activity for today
    trackActivity();

    // Get downloads
    const downloads = JSON.parse(localStorage.getItem('sp_downloads') || '[]');
    document.getElementById('stat-downloads').textContent = downloads.length;

    if (downloads.length > 0) {
      renderDownloads(downloads);
    }

    // Get bookmarks
    const bookmarks = JSON.parse(localStorage.getItem('sp_bookmarks') || '[]');
    document.getElementById('stat-bookmarks').textContent = bookmarks.length;

    if (bookmarks.length > 0) {
      renderBookmarks(bookmarks);
    }

    // Get favorites
    const favorites = JSON.parse(localStorage.getItem('sp_favorites') || '[]');
    if (favorites.length > 0) {
      renderFavorites(favorites);
    }

    // Get notes
    const notes = JSON.parse(localStorage.getItem('sp_lesson_notes') || '{}');
    const noteCount = Object.keys(notes).length;

    if (noteCount > 0) {
      renderNotes(notes);
    }

    // Get completed lessons (using correct key pattern: sp_edu_*_completed)
    const completedCount = Object.keys(localStorage).filter(k => k.includes('sp_edu_') && k.includes('_completed')).length;
    document.getElementById('stat-completed').textContent = completedCount;

    // Get and update streak
    const streak = updateStreak();
    document.getElementById('stat-streak').textContent = streak.current || 0;
    document.getElementById('streak-days').textContent = streak.current || 0;

    // Render visualizations
    renderStudyCalendar();
    renderStreakCalendar(streak);
    renderProgressChart();
    renderAchievements(completedCount);
    renderCertificates(completedCount);
  }

  // Track daily activity
  function trackActivity() {
    const today = new Date().toISOString().split('T')[0];
    const activity = JSON.parse(localStorage.getItem('sp_activity') || '{}');

    if (!activity[today]) {
      activity[today] = { visits: 1, lessonsCompleted: 0 };
    } else {
      activity[today].visits++;
    }

    localStorage.setItem('sp_activity', JSON.stringify(activity));

    // Debug: Log what we're tracking
    logger.log('[My Library] Tracking activity for:', today);
    logger.log('[My Library] Total visits today:', activity[today].visits);
  }

  // Debug helper - show what's in localStorage
  function debugLibraryData() {
    const completed = Object.keys(localStorage).filter(k => k.includes('sp_edu_') && k.includes('_completed'));
    const downloads = JSON.parse(localStorage.getItem('sp_downloads') || '[]');
    const bookmarks = JSON.parse(localStorage.getItem('sp_bookmarks') || '[]');
    const favorites = JSON.parse(localStorage.getItem('sp_favorites') || '[]');
    const activity = JSON.parse(localStorage.getItem('sp_activity') || '{}');

    logger.log('[My Library] DEBUG DATA:');
    logger.log('  - Completed lessons:', completed.length, completed);
    logger.log('  - Downloads:', downloads.length);
    logger.log('  - Bookmarks:', bookmarks.length);
    logger.log('  - Favorites:', favorites.length);
    logger.log('  - Activity days:', Object.keys(activity).length);
  }

  // Update streak based on activity
  function updateStreak() {
    const activity = JSON.parse(localStorage.getItem('sp_activity') || '{}');
    const dates = Object.keys(activity).sort();

    if (dates.length === 0) {
      return { current: 0, longest: 0, lastActivity: null };
    }

    const today = new Date().toISOString().split('T')[0];
    let currentStreak = 0;
    let longestStreak = 0;
    let tempStreak = 0;

    // Calculate streak
    for (let i = 0; i < dates.length; i++) {
      if (i === 0) {
        tempStreak = 1;
      } else {
        const prevDate = new Date(dates[i - 1]);
        const currDate = new Date(dates[i]);
        const diffDays = Math.floor((currDate - prevDate) / (1000 * 60 * 60 * 24));

        if (diffDays === 1) {
          tempStreak++;
        } else {
          tempStreak = 1;
        }
      }

      longestStreak = Math.max(longestStreak, tempStreak);

      // If this date chain includes today, it's current streak
      if (dates[i] === today) {
        currentStreak = tempStreak;
      }
    }

    const streak = { current: currentStreak, longest: longestStreak, lastActivity: dates[dates.length - 1] };
    localStorage.setItem('sp_learning_streak', JSON.stringify(streak));
    return streak;
  }

  function renderDownloads(downloads) {
    const container = document.getElementById('downloads-list');
    container.innerHTML = downloads.map(download => `
      <div class="library-item">
        <div class="library-item-info">
          <div class="library-item-title">üìÑ ${download.title}</div>
          <div class="library-item-meta">Downloaded ${new Date(download.date).toLocaleDateString()}</div>
        </div>
        <div class="library-item-actions">
          <a href="${download.url}" download class="btn btn-sm btn-primary">Re-download</a>
          <a href="${download.lessonUrl}" class="btn btn-sm btn-ghost">View Lesson</a>
        </div>
      </div>
    `).join('');
  }

  function renderBookmarks(bookmarks) {
    const container = document.getElementById('bookmarks-list');
    container.innerHTML = bookmarks.map(bookmark => `
      <div class="library-item">
        <div class="library-item-info">
          <div class="library-item-title">üîñ ${bookmark.title}</div>
          <div class="library-item-meta">${bookmark.tier} ‚Ä¢ ${bookmark.readTime || '15 min read'}</div>
        </div>
        <div class="library-item-actions">
          <a href="${bookmark.url}" class="btn btn-sm btn-primary">Read Now</a>
          <button onclick="window.library.removeBookmark('${bookmark.id}')" class="btn btn-sm btn-ghost">Remove</button>
        </div>
      </div>
    `).join('');
  }

  function renderNotes(notes) {
    const container = document.getElementById('notes-list');
    const noteEntries = Object.entries(notes);

    container.innerHTML = noteEntries.map(([lessonId, note]) => `
      <div class="library-item">
        <div class="library-item-info">
          <div class="library-item-title">üìù ${note.lessonTitle || lessonId}</div>
          <div class="library-item-meta">${note.content.substring(0, 100)}${note.content.length > 100 ? '...' : ''}</div>
        </div>
        <div class="library-item-actions">
          <a href="${note.lessonUrl || '#'}" class="btn btn-sm btn-primary">View Lesson</a>
        </div>
      </div>
    `).join('');
  }

  function renderAchievements(completedCount) {
    const achievements = [
      { id: 'first_lesson', title: 'üéØ First Steps', description: 'Complete your first lesson', unlocked: completedCount >= 1 },
      { id: 'beginner_complete', title: 'üü¢ Beginner Complete', description: 'Complete all 12 beginner lessons', unlocked: completedCount >= 12 },
      { id: 'halfway', title: '‚ö° Halfway There', description: 'Complete 21 lessons', unlocked: completedCount >= 21 },
      { id: 'intermediate_complete', title: 'üü° Intermediate Complete', description: 'Complete all intermediate lessons', unlocked: completedCount >= 27 },
      { id: 'all_lessons', title: 'üèÜ Master Trader', description: 'Complete all 42 lessons', unlocked: completedCount >= 42 },
      { id: 'week_streak', title: 'üî• Week Streak', description: '7 day learning streak', unlocked: false },
      { id: 'note_taker', title: 'üìù Note Taker', description: 'Take notes on 5 lessons', unlocked: false }
    ];

    const container = document.getElementById('achievements-list');
    const unlocked = achievements.filter(a => a.unlocked);

    if (unlocked.length === 0) {
      return; // Keep empty state
    }

    container.innerHTML = achievements.map(achievement => `
      <div class="achievement-badge ${achievement.unlocked ? '' : 'locked'}">
        <span style="font-size: 1.5rem;">${achievement.title.split(' ')[0]}</span>
        <div>
          <div style="font-weight: 600;">${achievement.title.substring(3)}</div>
          <div style="font-size: 0.85rem; opacity: 0.8;">${achievement.description}</div>
        </div>
      </div>
    `).join('');
  }

  // Render Study Calendar (90-day heatmap)
  function renderStudyCalendar() {
    const container = document.getElementById('study-calendar');
    const activity = JSON.parse(localStorage.getItem('sp_activity') || '{}');
    const today = new Date();
    const days = [];

    // Generate last 90 days
    for (let i = 89; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const activityLevel = activity[dateStr] ? Math.min(activity[dateStr].visits, 5) : 0;

      days.push({
        date: dateStr,
        level: activityLevel,
        tooltip: `${dateStr}: ${activityLevel > 0 ? activityLevel + ' visits' : 'No activity'}`
      });
    }

    container.innerHTML = `
      <div class="calendar-grid">
        ${days.map(day => `
          <div class="calendar-day ${day.level > 0 ? 'active-' + day.level : ''}"
               data-tooltip="${day.tooltip}"></div>
        `).join('')}
      </div>
      <div style="display: flex; align-items: center; gap: 0.5rem; font-size: 0.75rem; color: var(--muted); margin-top: 0.5rem;">
        <span>Less</span>
        <div class="calendar-day" style="width: 12px; height: 12px;"></div>
        <div class="calendar-day active-1" style="width: 12px; height: 12px;"></div>
        <div class="calendar-day active-2" style="width: 12px; height: 12px;"></div>
        <div class="calendar-day active-3" style="width: 12px; height: 12px;"></div>
        <div class="calendar-day active-4" style="width: 12px; height: 12px;"></div>
        <div class="calendar-day active-5" style="width: 12px; height: 12px;"></div>
        <span>More</span>
      </div>
    `;
  }

  // Render Streak Calendar (last 30 days)
  function renderStreakCalendar(streak) {
    const container = document.getElementById('streak-calendar');
    const activity = JSON.parse(localStorage.getItem('sp_activity') || '{}');
    const today = new Date();
    const days = [];

    // Generate last 30 days
    for (let i = 29; i >= 0; i--) {
      const date = new Date(today);
      date.setDate(date.getDate() - i);
      const dateStr = date.toISOString().split('T')[0];
      const hasActivity = !!activity[dateStr];
      const isToday = i === 0;

      days.push({
        date: dateStr,
        hasActivity: hasActivity,
        isToday: isToday,
        dayName: date.toLocaleDateString('en-US', { weekday: 'short' }).substring(0, 1)
      });
    }

    container.innerHTML = days.map(day => `
      <div class="streak-day ${day.hasActivity ? 'completed' : ''} ${day.isToday ? 'today' : ''}"
           title="${day.date}">
        ${day.hasActivity ? '‚úì' : ''}
      </div>
    `).join('');
  }

  // Render Progress Chart
  function renderProgressChart() {
    const container = document.getElementById('progress-chart');
    const activity = JSON.parse(localStorage.getItem('sp_activity') || '{}');
    const today = new Date();
    const weeks = [];

    // Generate last 8 weeks
    for (let i = 7; i >= 0; i--) {
      const weekStart = new Date(today);
      weekStart.setDate(weekStart.getDate() - (i * 7));
      const weekEnd = new Date(weekStart);
      weekEnd.setDate(weekEnd.getDate() + 6);

      let weekActivity = 0;
      for (let d = 0; d < 7; d++) {
        const checkDate = new Date(weekStart);
        checkDate.setDate(checkDate.getDate() + d);
        const dateStr = checkDate.toISOString().split('T')[0];
        if (activity[dateStr]) {
          weekActivity += activity[dateStr].visits || 0;
        }
      }

      weeks.push({
        label: i === 0 ? 'This week' : `${i} ${i === 1 ? 'week' : 'weeks'} ago`,
        value: weekActivity,
        max: 20 // Max expected visits per week for scaling
      });
    }

    const maxValue = Math.max(...weeks.map(w => w.value), 1);

    container.innerHTML = `
      <div class="progress-bar-container">
        ${weeks.map(week => `
          <div class="progress-bar-item">
            <div class="progress-bar-label">${week.label}</div>
            <div class="progress-bar-track">
              <div class="progress-bar-fill" style="width: ${(week.value / maxValue) * 100}%">
                ${week.value > 0 ? week.value : ''}
              </div>
            </div>
          </div>
        `).join('')}
      </div>
    `;
  }

  // Render Favorites
  function renderFavorites(favorites) {
    const container = document.getElementById('favorites-list');
    container.innerHTML = favorites.map(fav => `
      <div class="library-item">
        <div class="library-item-info">
          <div class="library-item-title">‚≠ê ${fav.title}</div>
          <div class="library-item-meta">${fav.tier} ‚Ä¢ Starred ${new Date(fav.date).toLocaleDateString()}</div>
        </div>
        <div class="library-item-actions">
          <a href="${fav.url}" class="btn btn-sm btn-primary">Read Now</a>
          <button onclick="window.library.removeFavorite('${fav.id}')" class="btn btn-sm btn-ghost">Remove</button>
        </div>
      </div>
    `).join('');
  }

  // Render Certificates
  function renderCertificates(completedCount) {
    const tiers = {
      beginner: { completed: 0, total: 12 },
      intermediate: { completed: 0, total: 15 },
      advanced: { completed: 0, total: 15 },
      master: { completed: completedCount, total: 42 }
    };

    // Count completed by tier (simplified - you can enhance this)
    // For now, assume sequential completion
    if (completedCount >= 12) tiers.beginner.completed = 12;
    else tiers.beginner.completed = Math.min(completedCount, 12);

    if (completedCount > 12) tiers.intermediate.completed = Math.min(completedCount - 12, 15);
    if (completedCount > 27) tiers.advanced.completed = Math.min(completedCount - 27, 15);

    // Update progress displays
    document.getElementById('cert-beginner-progress').textContent = `${tiers.beginner.completed}/${tiers.beginner.total} lessons`;
    document.getElementById('cert-intermediate-progress').textContent = `${tiers.intermediate.completed}/${tiers.intermediate.total} lessons`;
    document.getElementById('cert-advanced-progress').textContent = `${tiers.advanced.completed}/${tiers.advanced.total} lessons`;
    document.getElementById('cert-master-progress').textContent = `${tiers.master.completed}/${tiers.master.total} lessons`;

    // Enable/unlock certificates
    if (tiers.beginner.completed >= tiers.beginner.total) {
      const card = document.querySelector('[data-tier="beginner"]');
      const btn = document.getElementById('cert-beginner-btn');
      card.classList.add('unlocked');
      btn.disabled = false;
      btn.onclick = () => generateCertificate('Beginner');
    }

    if (tiers.intermediate.completed >= tiers.intermediate.total) {
      const card = document.querySelector('[data-tier="intermediate"]');
      const btn = document.getElementById('cert-intermediate-btn');
      card.classList.add('unlocked');
      btn.disabled = false;
      btn.onclick = () => generateCertificate('Intermediate');
    }

    if (tiers.advanced.completed >= tiers.advanced.total) {
      const card = document.querySelector('[data-tier="advanced"]');
      const btn = document.getElementById('cert-advanced-btn');
      card.classList.add('unlocked');
      btn.disabled = false;
      btn.onclick = () => generateCertificate('Advanced');
    }

    if (tiers.master.completed >= tiers.master.total) {
      const card = document.querySelector('[data-tier="master"]');
      const btn = document.getElementById('cert-master-btn');
      card.classList.add('unlocked');
      btn.disabled = false;
      btn.onclick = () => generateCertificate('Master Trader');
    }
  }

  // Generate Certificate
  function generateCertificate(tier) {
    const today = new Date().toLocaleDateString('en-US', { year: 'numeric', month: 'long', day: 'numeric' });
    const userName = 'Trading Student'; // Get from auth if available

    const certificateHTML = `
      <!DOCTYPE html>
      <html>
      <head>
        <title>Certificate of Completion - ${tier}</title>
        <style>
          @page { size: landscape; margin: 0; }
          * { margin: 0; padding: 0; box-sizing: border-box; }
          body {
            font-family: 'Georgia', serif;
            background: linear-gradient(135deg, #0a0e1a 0%, #1a2332 100%);
            color: #fff;
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 2rem;
          }
          .certificate {
            background: linear-gradient(135deg, #0f1420 0%, #1a2845 100%);
            border: 8px solid #5b8aff;
            border-radius: 20px;
            padding: 4rem;
            max-width: 900px;
            text-align: center;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
          }
          .logo { font-size: 3rem; margin-bottom: 1rem; font-weight: 700; background: linear-gradient(135deg, #5b8aff, #76ddff); -webkit-background-clip: text; background-clip: text; -webkit-text-fill-color: transparent; }
          h1 { font-size: 3rem; margin: 2rem 0; letter-spacing: 2px; color: #5b8aff; }
          .awarded { font-size: 1.2rem; margin: 1rem 0; opacity: 0.9; }
          .name { font-size: 2.5rem; margin: 2rem 0; padding: 1rem 2rem; border-bottom: 3px solid #5b8aff; display: inline-block; }
          .achievement { font-size: 1.5rem; margin: 2rem 0; }
          .tier { font-size: 2rem; color: #76ddff; font-weight: 700; }
          .date { margin-top: 3rem; font-size: 1rem; opacity: 0.7; }
          .signature { margin-top: 2rem; padding-top: 2rem; border-top: 2px solid rgba(255,255,255,0.2); display: flex; justify-content: space-around; }
          .signature div { font-size: 0.9rem; }
          .signature-line { width: 200px; border-top: 2px solid #5b8aff; margin: 0 auto 0.5rem; }
        </style>
      </head>
      <body>
        <div class="certificate">
          <div class="logo">Signal Pilot</div>
          <h1>Certificate of Completion</h1>
          <div class="awarded">This is to certify that</div>
          <div class="name">${userName}</div>
          <div class="achievement">has successfully completed the</div>
          <div class="tier">${tier} Tier</div>
          <div class="achievement">of the Signal Pilot Trading Education Program</div>
          <div class="date">Awarded on ${today}</div>
          <div class="signature">
            <div>
              <div class="signature-line"></div>
              <div>Signal Pilot Education</div>
            </div>
          </div>
        </div>
        <script>
          window.onload = () => {
            setTimeout(() => window.print(), 500);
          };
        </script>
      </body>
      </html>
    `;

    // Open certificate in new window for printing/download
    const certWindow = window.open('', '_blank');
    certWindow.document.write(certificateHTML);
    certWindow.document.close();
  }

  // Public API
  window.library = {
    removeBookmark: function(id) {
      const bookmarks = JSON.parse(localStorage.getItem('sp_bookmarks') || '[]');
      const filtered = bookmarks.filter(b => b.id !== id);
      localStorage.setItem('sp_bookmarks', JSON.stringify(filtered));
      loadLibraryData();
    },
    removeFavorite: function(id) {
      const favorites = JSON.parse(localStorage.getItem('sp_favorites') || '[]');
      const filtered = favorites.filter(f => f.id !== id);
      localStorage.setItem('sp_favorites', JSON.stringify(filtered));
      loadLibraryData();
    }
  };

  // Load on page load
  loadLibraryData();

  // Run debug on page load (can be disabled in production)
  if (localStorage.getItem('sp_debug_mode') === 'true') {
    debugLibraryData();
  }

  // Expose debug function globally for console access
  window.debugLibrary = debugLibraryData;

})();

// Auto-enable debug on first load to help user
if (!localStorage.getItem('sp_library_initialized')) {
  localStorage.setItem('sp_library_initialized', 'true');
  localStorage.setItem('sp_debug_mode', 'true');
  console.log('%cüìö My Library Debug Mode Enabled', 'color: #5b8aff; font-size: 14px; font-weight: bold;');
  console.log('%cType debugLibrary() in console to see your data', 'color: #76ddff;');
}
</script>
</body>
</html>
